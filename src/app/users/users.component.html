<!-- ================= TOASTS ================= -->
<div class="fixed top-6 right-6 z-[100] space-y-3">
  <div
    *ngFor="let toast of toasts"
    class="flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg
           text-white animate-slide-in"
    [ngClass]="{
      'bg-green-600': toast.type === 'success',
      'bg-red-600': toast.type === 'error',
      'bg-blue-600': toast.type === 'info'
    }"
  >
    <span class="text-sm font-medium">{{ toast.message }}</span>
    <button
      (click)="removeToast(toast.id)"
      class="ml-auto text-white/80 hover:text-white"
    >
      âœ•
    </button>
  </div>
</div>

<!-- ================= LOADER ================= -->
<div
  *ngIf="isLoading"
  class="fixed inset-0 z-50 flex items-center justify-center
         bg-white/80 backdrop-blur-sm"
>
  <div class="flex flex-col items-center gap-4">
    <div
      class="h-12 w-12 border-4 border-indigo-600
             border-t-transparent rounded-full animate-spin"
    ></div>
    <p class="text-sm text-slate-600">Loading...</p>
  </div>
</div>

<!-- ================= PAGE ================= -->
<div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-10">
  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- ================= USER FORM ================= -->
    <div class="lg:col-span-1 bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl p-6">
      <h2 class="text-2xl font-semibold text-slate-800 mb-2">
        {{ editingUserId ? 'Edit User' : 'Create User' }}
      </h2>

      <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="space-y-5">

        <!-- Name -->
        <div>
          <input
            formControlName="userName"
            type="text"
            class="w-full px-4 pt-6 pb-2 border rounded-xl"
            placeholder="Name"
          />
          <p
            *ngIf="userForm.get('userName')?.touched && userForm.get('userName')?.errors?.['required']"
            class="text-xs text-red-500 mt-1"
          >
            Name is required
          </p>
        </div>

        <!-- Phone -->
        <div>
          <input
            formControlName="userPhoneNumber"
            type="text"
            class="w-full px-4 pt-6 pb-2 border rounded-xl"
            placeholder="Phone"
          />
          <p
            *ngIf="userForm.get('userPhoneNumber')?.touched && userForm.get('userPhoneNumber')?.errors?.['required']"
            class="text-xs text-red-500 mt-1"
          >
            Phone number is required
          </p>
          <p
            *ngIf="userForm.get('userPhoneNumber')?.touched && userForm.get('userPhoneNumber')?.errors?.['invalidPhone']"
            class="text-xs text-red-500 mt-1"
          >
            Enter valid 10-digit Indian mobile number
          </p>
        </div>

        <!-- Password -->
        <div *ngIf="!editingUserId">
          <input
            formControlName="userPassword"
            type="password"
            class="w-full px-4 pt-6 pb-2 border rounded-xl"
            placeholder="Password"
          />
          <p
            *ngIf="userForm.get('userPassword')?.touched && userForm.get('userPassword')?.errors?.['required']"
            class="text-xs text-red-500 mt-1"
          >
            Password is required
          </p>
          <p
            *ngIf="userForm.get('userPassword')?.touched && userForm.get('userPassword')?.errors?.['weakPassword']"
            class="text-xs text-red-500 mt-1"
          >
            Password must be 8+ chars, include uppercase, lowercase, number & symbol
          </p>
        </div>

        <!-- Addresses -->
        <div formArrayName="addresses" class="space-y-3">
          <label class="text-sm font-medium">Addresses</label>

          <div
            *ngFor="let addr of addresses.controls; let i = index"
            [formGroupName]="i"
          >
            <textarea
              formControlName="fullAddress"
              rows="2"
              class="w-full px-4 py-2 border rounded-xl"
              placeholder="Full Address"
            ></textarea>
            <p
              *ngIf="addr.get('fullAddress')?.touched && addr.get('fullAddress')?.errors?.['required']"
              class="text-xs text-red-500 mt-1"
            >
              Address is required
            </p>
          </div>

          <button
            type="button"
            (click)="addAddress()"
            class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-xl"
          >
            + Add Address
          </button>
        </div>

        <!-- Status -->
        <div class="flex gap-3">
          <button
            type="button"
            (click)="userForm.patchValue({ status: 'ACTIVE' })"
            class="flex-1 py-2 rounded-xl"
            [ngClass]="userForm.value.status === 'ACTIVE'
              ? 'bg-indigo-600 text-white'
              : 'bg-slate-200'"
          >
            Active
          </button>

          <button
            type="button"
            (click)="userForm.patchValue({ status: 'INACTIVE' })"
            class="flex-1 py-2 rounded-xl"
            [ngClass]="userForm.value.status === 'INACTIVE'
              ? 'bg-rose-500 text-white'
              : 'bg-slate-200'"
          >
            Inactive
          </button>
        </div>

        <button
          type="submit"
          [disabled]="userForm.invalid || isLoading"
          class="w-full py-3 bg-indigo-600 text-white rounded-xl"
        >
          {{ editingUserId ? 'Update User' : 'Create User' }}
        </button>

      </form>
    </div>

    <!-- ================= USERS TABLE ================= -->
    <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl overflow-hidden">
      <table class="w-full text-sm">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-6 py-3 text-left">Name</th>
            <th class="px-6 py-3 text-left">Phone</th>
            <th class="px-6 py-3 text-left">Status</th>
            <th class="px-6 py-3 text-right">Actions</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let u of users" class="border-t">
            <td class="px-6 py-4">{{ u.userName }}</td>
            <td class="px-6 py-4">{{ u.userPhoneNumber }}</td>
            <td class="px-6 py-4">{{ u.status }}</td>
            <td class="px-6 py-4 text-right space-x-2">
              <button (click)="editUser(u)">Edit</button>
              <button (click)="openPasswordModal(u)">Change Password</button>
              <button (click)="deleteUser(u.userId!)">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- ================= PASSWORD MODAL ================= -->
<div *ngIf="showPasswordModal" class="fixed inset-0 flex items-center justify-center bg-black/40">
  <div class="bg-white rounded-2xl p-6 w-full max-w-md">
    <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="space-y-4">

      <input type="password" formControlName="oldPassword" placeholder="Old Password" class="w-full border px-4 py-2 rounded-xl" />
      <input type="password" formControlName="newPassword" placeholder="New Password" class="w-full border px-4 py-2 rounded-xl" />
      <input type="password" formControlName="confirmPassword" placeholder="Confirm Password" class="w-full border px-4 py-2 rounded-xl" />

      <p *ngIf="passwordForm.errors?.['passwordMismatch']" class="text-xs text-red-500">
        Passwords do not match
      </p>

      <button type="submit" [disabled]="passwordForm.invalid" class="w-full bg-indigo-600 text-white py-2 rounded-xl">
        Update Password
      </button>

    </form>
  </div>
</div>

<!-- ================= TOASTS ================= -->
<div class="fixed top-6 right-6 z-[100] space-y-3">
  <div
    *ngFor="let toast of toasts"
    class="flex items-center gap-3 px-4 py-3 rounded-xl shadow-lg text-white"
    [ngClass]="{
      'bg-green-600': toast.type === 'success',
      'bg-red-600': toast.type === 'error',
      'bg-blue-600': toast.type === 'info'
    }"
  >
    <span class="text-sm font-medium">{{ toast.message }}</span>
    <button (click)="removeToast(toast.id)" class="ml-auto">âœ•</button>
  </div>
</div>

<!-- ================= LOADER ================= -->
<div *ngIf="isLoading" class="fixed inset-0 z-50 flex items-center justify-center bg-white/80">
  <div class="h-12 w-12 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
</div>

<!-- ================= PAGE ================= -->
<div class="min-h-screen bg-slate-100 p-10">
  <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

    <!-- ================= USER FORM ================= -->
    <div class="bg-white rounded-2xl shadow-xl p-6 lg:col-span-1">
      <h2 class="text-xl font-semibold mb-4">
        {{ editingUserId ? 'Edit User' : 'Create User' }}
      </h2>

      <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="space-y-4">

        <!-- Name -->
        <input
          formControlName="userName"
          type="text"
          placeholder="Name"
          class="w-full px-4 py-2 border border-slate-200 rounded-xl outline-none
                 focus:ring-2 focus:ring-indigo-500"
        />

        <!-- Phone -->
        <input
          formControlName="userPhoneNumber"
          type="text"
          placeholder="Phone"
          class="w-full px-4 py-2 border border-slate-200 rounded-xl outline-none
                 focus:ring-2 focus:ring-indigo-500"
        />

        <!-- Password -->
        <input
          *ngIf="!editingUserId"
          formControlName="userPassword"
          type="password"
          placeholder="Password"
          class="w-full px-4 py-2 border border-slate-200 rounded-xl outline-none
                 focus:ring-2 focus:ring-indigo-500"
        />

        <!-- Addresses -->
        <div formArrayName="addresses" class="space-y-3">
          <label class="text-sm font-medium">Addresses</label>

          <div *ngFor="let addr of addresses.controls; let i = index" [formGroupName]="i">
            <textarea
              formControlName="fullAddress"
              rows="2"
              placeholder="Full Address"
              class="w-full px-4 py-2 border border-slate-200 rounded-xl outline-none
                     focus:ring-2 focus:ring-indigo-500"
            ></textarea>
          </div>

          <button
            type="button"
            (click)="addAddress()"
            class="px-4 py-2 bg-indigo-100 rounded-xl"
          >
            + Add Address
          </button>
        </div>

        <!-- Submit -->
        <button
          type="submit"
          class="w-full py-3 bg-indigo-600 text-white rounded-xl"
          [disabled]="isLoading"
        >
          {{ editingUserId ? 'Update User' : 'Create User' }}
        </button>

      </form>
    </div>

    <!-- ================= USERS TABLE ================= -->
    <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl overflow-hidden">
      <table class="w-full">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-6 py-3 text-left">Name</th>
            <th class="px-6 py-3 text-left">Phone</th>
            <th class="px-6 py-3 text-left">Status</th>
            <th class="px-6 py-3 text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let u of users" class="border-t">
            <td class="px-6 py-3">{{ u.userName }}</td>
            <td class="px-6 py-3">{{ u.userPhoneNumber }}</td>
            <td class="px-6 py-3">{{ u.status }}</td>
            <td class="px-6 py-3 text-right space-x-2">
              <button (click)="editUser(u)">Edit</button>
              <button (click)="openPasswordModal(u)">Change Password</button>
              <button (click)="deleteUser(u.userId!)">Delete</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
     <div class="lg:col-span-2 bg-white rounded-2xl shadow-xl overflow-hidden">

      <div class="p-6 border-b flex justify-between items-center">
        <h3 class="text-lg font-semibold text-slate-800">Users</h3>
        <span class="text-sm text-slate-500">
          {{ users.length }} records
        </span>
      </div>

      <table class="w-full text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="px-6 py-3 text-left">Name</th>
            <th class="px-6 py-3 text-left">Phone</th>
            <th class="px-6 py-3 text-left">Status</th>
            <th class="px-6 py-3 text-right">Actions</th>
          </tr>
        </thead>

        <tbody>
          <tr
            *ngFor="let u of users"
            class="border-t hover:bg-slate-50 transition"
          >
            <td class="px-6 py-4 font-medium">{{ u.userName }}</td>
            <td class="px-6 py-4 text-slate-600">{{ u.userPhoneNumber }}</td>
            <td class="px-6 py-4">
              <span
                class="px-3 py-1 rounded-full text-xs font-semibold"
                [ngClass]="u.status === 'ACTIVE'
                  ? 'bg-green-100 text-green-700'
                  : 'bg-rose-100 text-rose-700'"
              >
                {{ u.status }}
              </span>
            </td>
            <td class="px-6 py-4 text-right space-x-2">
              <button
                (click)="editUser(u)"
                class="px-3 py-1 rounded-lg bg-slate-200 hover:bg-slate-300"
              >
                Edit
              </button>

              <button
                (click)="openPasswordModal(u)"
                class="px-3 py-1 rounded-lg bg-indigo-500
                       text-white hover:bg-indigo-600"
              >
                Change Password
              </button>

              <button
                *ngIf="u.userId !== undefined"
                (click)="deleteUser(u.userId)"
                class="px-3 py-1 rounded-lg bg-rose-500
                       text-white hover:bg-rose-600"
              >
                Delete
              </button>
            </td>
          </tr>
        </tbody>
      </table>

    </div>
  </div>
</div>

<!-- ================= PASSWORD MODAL ================= -->
<div *ngIf="showPasswordModal" class="fixed inset-0 flex items-center justify-center bg-black/40">
  <div class="bg-white p-6 rounded-2xl w-full max-w-md">
    <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="space-y-4">

      <input
        type="password"
        formControlName="oldPassword"
        placeholder="Old Password"
        class="w-full px-4 py-2 border border-slate-200 rounded-xl"
      />

      <input
        type="password"
        formControlName="newPassword"
        placeholder="New Password"
        class="w-full px-4 py-2 border border-slate-200 rounded-xl"
      />

      <input
        type="password"
        formControlName="confirmPassword"
        placeholder="Confirm Password"
        class="w-full px-4 py-2 border border-slate-200 rounded-xl"
      />

      <button
        type="submit"
        [disabled]="passwordForm.invalid"
        class="w-full bg-indigo-600 text-white py-2 rounded-xl"
      >
        Update Password
      </button>

    </form>
  </div>
</div>
